'use strict';

// Uploads cover images from "frontend/uploads/<Industry Name> cover-pic"
// to Cloudinary and updates frontend/src/images.js to include a coverImages array
// for each industry.

const path = require('path');
const fs = require('fs');
const { glob } = require('glob');
const cloudinaryService = require('../services/cloudinary');

function pathToFileURL(p) {
  const { pathToFileURL: toURL } = require('url');
  return toURL(p);
}

function sanitizeKey(name) {
  return name
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

async function importIndustryImages(imagesJsFile) {
  const mod = await import(pathToFileURL(imagesJsFile).href);
  const images = mod.default || mod.industryImages || {};
  return images;
}

async function uploadCoverImagesForIndustry(displayName, files) {
  const safeSubService = sanitizeKey(displayName);
  const serviceType = 'industries';
  const uploaded = [];

  for (const file of files) {
    const result = await cloudinaryService.uploadImage(
      file,
      serviceType,
      `${safeSubService}/covers`,
      null
    );
    uploaded.push({
      file: path.basename(file),
      url: result.url,
      publicId: result.public_id
    });
  }
  return uploaded;
}

function buildImagesJsContent(map) {
  const lines = [];
  lines.push('// Auto-generated by backend/src/scripts/upload-industry-cover-images.js');
  lines.push('// Do not edit manually. Re-run the script to update.');
  lines.push('');
  lines.push('export const industryImages = {');
  for (const [key, val] of Object.entries(map)) {
    lines.push(`  "${key}": {`);
    lines.push(`    name: ${JSON.stringify(val.name)},`);
    lines.push('    images: [');
    for (const u of val.images || []) {
      lines.push(`      { file: ${JSON.stringify(u.file)}, url: ${JSON.stringify(u.url)}, publicId: ${JSON.stringify(u.publicId)} },`);
    }
    lines.push('    ],');
    if (val.coverImages && val.coverImages.length > 0) {
      lines.push('    coverImages: [');
      for (const u of val.coverImages) {
        lines.push(`      { file: ${JSON.stringify(u.file)}, url: ${JSON.stringify(u.url)}, publicId: ${JSON.stringify(u.publicId)} },`);
      }
      lines.push('    ]');
    } else {
      lines.push('    coverImages: []');
    }
    lines.push('  },');
  }
  lines.push('};');
  lines.push('');
  lines.push('export default industryImages;');
  lines.push('');
  return lines.join('\n');
}

async function main() {
  const repoRoot = path.resolve(__dirname, '../../..');
  const uploadsRoot = path.join(repoRoot, 'frontend', 'uploads');
  const imagesJsPath = path.join(repoRoot, 'frontend', 'src', 'images.js');

  // Load existing map
  const existing = await importIndustryImages(imagesJsPath);

  // Normalize to working structure
  const map = {};
  for (const [k, v] of Object.entries(existing)) {
    map[k] = {
      name: v?.name || k,
      images: Array.isArray(v?.images) ? v.images : [],
      coverImages: Array.isArray(v?.coverImages) ? v.coverImages : []
    };
  }

  // Find cover folders with "cover-pic" suffix
  const coverDirs = await fs.promises.readdir(uploadsRoot, { withFileTypes: true });
  const coverSuffix = ' cover-pic';
  const targets = coverDirs.filter(d => d.isDirectory() && d.name.toLowerCase().endsWith(coverSuffix));

  console.log(`Found ${targets.length} industry cover folders:`);
  targets.forEach(target => console.log(`  - ${target.name}`));

  for (const dirent of targets) {
    const folderName = dirent.name;
    const displayName = folderName.slice(0, -coverSuffix.length);
    const safeKey = sanitizeKey(displayName);

    console.log(`\nProcessing: ${displayName} (${safeKey})`);

    // Resolve key by name or safe key
    let key = Object.keys(map).find(k => map[k].name === displayName);
    if (!key) key = safeKey;
    if (!map[key]) {
      map[key] = { name: displayName, images: [], coverImages: [] };
    }

    const absFolder = path.join(uploadsRoot, folderName);
    const pattern = path.join(absFolder, '*.{png,jpg,jpeg,webp}').replace(/\\/g, '/');
    const files = await glob(pattern, { nocase: true });
    
    if (files.length === 0) {
      console.log(`  No images found in ${folderName}`);
      continue;
    }

    console.log(`  Found ${files.length} images to upload`);
    const uploaded = await uploadCoverImagesForIndustry(displayName, files);
    map[key].coverImages = uploaded;
    console.log(`  Uploaded ${uploaded.length} images to Cloudinary`);
  }

  // Write back images.js
  await fs.promises.mkdir(path.dirname(imagesJsPath), { recursive: true });
  const content = buildImagesJsContent(map);
  await fs.promises.writeFile(imagesJsPath, content, 'utf8');
  console.log(`\nUpdated ${imagesJsPath}`);
  console.log('Industry cover images upload completed successfully!');
}

main().catch((err) => {
  console.error('Error:', err);
  process.exit(1);
});
