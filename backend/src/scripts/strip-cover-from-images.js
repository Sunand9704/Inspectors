'use strict';

const path = require('path');
const fs = require('fs');

function pathToFileURL(p) {
  const { pathToFileURL: toURL } = require('url');
  return toURL(p);
}

async function importIndustryImages(imagesJsFile) {
  const mod = await import(pathToFileURL(imagesJsFile).href);
  return mod.default || mod.industryImages || {};
}

function buildImagesJsContent(map) {
  const lines = [];
  lines.push('// Auto-generated by backend/src/scripts/strip-cover-from-images.js');
  lines.push('// Do not edit manually. Re-run the script to update.');
  lines.push('');
  lines.push('export const industryImages = {');
  for (const [key, val] of Object.entries(map)) {
    lines.push(`  "${key}": {`);
    lines.push(`    name: ${JSON.stringify(val.name)},`);
    lines.push('    images: [');
    for (const u of val.images || []) {
      lines.push(`      { file: ${JSON.stringify(u.file)}, url: ${JSON.stringify(u.url)}, publicId: ${JSON.stringify(u.publicId)} },`);
    }
    lines.push('    ]');
    lines.push('  },');
  }
  lines.push('};');
  lines.push('');
  lines.push('export default industryImages;');
  lines.push('');
  return lines.join('\n');
}

async function main() {
  const repoRoot = path.resolve(__dirname, '../../..');
  const imagesJsPath = path.join(repoRoot, 'frontend', 'src', 'images.js');

  await fs.promises.access(imagesJsPath, fs.constants.R_OK);
  const images = await importIndustryImages(imagesJsPath);

  const cleaned = {};
  for (const [key, val] of Object.entries(images)) {
    cleaned[key] = {
      name: val?.name || key,
      images: Array.isArray(val?.images) ? val.images : []
    };
  }

  const content = buildImagesJsContent(cleaned);
  await fs.promises.writeFile(imagesJsPath, content, 'utf8');
  // eslint-disable-next-line no-console
  console.log(`Stripped coverImages and updated ${imagesJsPath}`);
}

main().catch((err) => {
  // eslint-disable-next-line no-console
  console.error(err);
  process.exit(1);
});


